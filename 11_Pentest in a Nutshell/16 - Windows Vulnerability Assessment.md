# 16 - Windows Vulnerability Assessment



## 1. Focusing the Assessment

Our initial enumeration revealed two high-potential avenues for privilege escalation. Our vulnerability assessment will focus on validating these findings.

*   **Primary Finding 1:** A scheduled task (`CorpBackupAgent`) runs as the `Administrator` user and executes a script located at `C:\ProgramData\CorpBackup\Scripts\backupprep.ps1`.
*   **Primary Finding 2:** The `C:\ProgramData` directory is writable by the `BUILTIN\Users` group, which our user `john` is a member of.

**Hypothesis:** If we have write permissions on the `backupprep.ps1` script, we can modify it with a malicious payload. When the scheduled task runs, our payload will be executed with `Administrator` privileges.

---

## 2. Validating the Vulnerability

The next step is to confirm our hypothesis by manually investigating the file and directory permissions.

### Step 1: Explore the Directory Structure
First, we confirm that we can read the contents of the `C:\ProgramData` directory and its subdirectories.

*   We navigate to `C:\ProgramData` and list its contents.
    ```powershell
    PS C:\> cd C:\ProgramData
    PS C:\ProgramData> ls
    ```
*   We identify the interesting `CorpBackup` directory and explore its contents.
    ```powershell
    PS C:\ProgramData> ls .\CorpBackup\
    # Output shows 'Logs' and 'Scripts' subdirectories

    PS C:\ProgramData> ls .\CorpBackup\Scripts\
    # Output shows the target file: backupprep.ps1
    ```
This confirms that we can at least read the directory structure, which is a good first sign.

### Step 2: Verify File Permissions with `icacls`
This is the critical step to confirm our hypothesis. We use the `icacls` command to check the exact NTFS permissions on the `backupprep.ps1` script file.

*   **Command:**
    ```powershell
    icacls "C:\ProgramData\CorpBackup\Scripts\backupprep.ps1"
    ```
*   **Result:**
    ```
    C:\ProgramData\CorpBackup\Scripts\backupprep.ps1 Everyone:(I)(F)
                                                     NT AUTHORITY\SYSTEM:(I)(F)
                                                     BUILTIN\Administrators:(I)(F)
    ```

### Analysis of the `icacls` Output
*   **`Everyone:(I)(F)`**: This is the **critical vulnerability**.
    *   **`Everyone`**: This security principal includes all authenticated users, including our user `john`.
    *   **(I)**: The permission is **I**nherited from a parent directory.
    *   **(F)**: The permission granted is **F**ull Control.
*   **Conclusion:** The `backupprep.ps1` script has **Full Control** permissions for the `Everyone` group. This means that **any authenticated user on the system can read, write, modify, and delete this script.**

---

## 3. Final Assessment and Action Plan

Our vulnerability assessment has confirmed a high-impact, easily exploitable privilege escalation path.

*   **The Vulnerability:** Insecure File Permissions on a script executed by a privileged scheduled task.
*   **The Root Cause:** The parent directory (`C:\ProgramData`) was misconfigured to be world-writable, and the `backupprep.ps1` script inherited these insecure permissions.
*   **The Action Plan:** The next step in the **Exploitation** phase is to:
    1.  Craft a malicious payload (e.g., a PowerShell reverse shell).
    2.  Overwrite the contents of `C:\ProgramData\CorpBackup\Scripts\backupprep.ps1` with our payload.
    3.  Set up a listener on our attacker machine.
    4.  Wait for the `CorpBackupAgent` scheduled task to run (which we know from enumeration happens every 2 minutes), which will execute our payload and give us a shell with `Administrator` privileges.
