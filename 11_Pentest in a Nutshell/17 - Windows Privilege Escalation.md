# 17 - Windows Privilege Escalation

## 1. Recap of the Vulnerability

Our vulnerability assessment confirmed a direct and reliable path to privilege escalation:

*   **The Vulnerability:** A scheduled task, `CorpBackupAgent`, runs with `Administrator` privileges every two minutes.
*   **The Flaw:** This task executes a PowerShell script, `backupprep.ps1`, located in a directory (`C:\ProgramData\CorpBackup\Scripts\`) where our current user, `john`, has **Full Control** permissions.
*   **The Plan:** We will modify the `backupprep.ps1` script to include a malicious command. When the task runs, our command will be executed with `Administrator` privileges.

---

## 2. The Privilege Escalation Process

### Step 1: Verify Current Privileges
Before the attack, we confirm the current group memberships for the user `john` to establish a baseline.

*   **Command:**
    ```powershell
    net user john
    ```
*   **Result:** The output shows that `john` is a member of standard groups like `Users`, `Remote Desktop Users`, and `Event Log Readers`, but **not** the `Administrators` group.

### Step 2: The Malicious Payload
Our goal is to add the user `john` to the local `Administrators` group. The PowerShell cmdlet for this is `Add-LocalGroupMember`.

*   **The Payload:**
    ```powershell
    Add-LocalGroupMember -Group "Administrators" -Member "WIN01\john"
    ```

### Step 3: Injecting the Payload
Using our RDP session, we open the `backupprep.ps1` script in Notepad and append our malicious payload to the end of the file.

*   **File Path:** `C:\ProgramData\CorpBackup\Scripts\backupprep.ps1`
*   **Action:** Add the `Add-LocalGroupMember` command to the last line of the script and save the file.

### Step 4: Wait for Execution
We know from our enumeration that the `CorpBackupAgent` task is triggered to run **every two minutes**. We wait for this interval to pass for the task to execute our modified script.

### Step 5: Verify Escalation
After waiting, we re-run the `net user john` command to check if our privileges have changed.

*   **Command:**
    ```powershell
    net user john
    ```
*   **Result:**
    ```
    Local Group Memberships      *Administrators       *Event Log Readers
                                 *Remote Desktop Users *Users
    ```
*   **Conclusion:** **Success.** The output confirms that `john` is now a member of the `Administrators` group. We have successfully escalated our privileges.

---

## 3. Summary of the Attack

*   **Vulnerability:** Insecure file permissions on a script executed by a high-privilege scheduled task.
*   **Exploitation:** Modified the script to add our user to the local `Administrators` group.
*   **Outcome:** Gained full administrative control over the Windows Server host.
*   **Persistence:** The malicious line remains in the script. This means that even if an administrator removes `john` from the `Administrators` group, the scheduled task will automatically add him back within two minutes, creating a simple and effective persistence mechanism.

With administrative access, the next steps in a penetration test would be to move into the **pillaging** and **lateral movement** phases, such as using a tool like Mimikatz to dump credentials from the `lsass.exe` process to find other user and domain passwords.
