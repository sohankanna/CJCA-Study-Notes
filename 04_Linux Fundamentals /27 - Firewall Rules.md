# Firewall Rules 
## The Netfilter Framework and `iptables`

*   **Netfilter:** The underlying packet filtering framework built directly into the Linux kernel. It provides "hooks" at various points in the network stack where packets can be intercepted and manipulated.
*   **`iptables`:** The classic user-space command-line utility used to configure and manage the rules that the Netfilter framework will enforce.

**Modern Alternatives:** While `iptables` is foundational, many modern distributions use more user-friendly front-ends or newer backends:
*   **UFW (Uncomplicated Firewall):** A simplified front-end for `iptables`, common on Ubuntu.
*   **firewalld:** A dynamic firewall manager, common on Red Hat/CentOS.
*   **nftables:** The modern successor to `iptables`, offering a more efficient and unified syntax.

---

## The Core Components of `iptables`

`iptables` is organized in a hierarchical structure of tables, chains, and rules.

### 1. Tables
Tables are the highest level of organization, grouping rules by their general purpose.

| Table Name | Primary Purpose | Built-in Chains |
| :--- | :--- | :--- |
| **`filter`** | The **default** and most used table. It is used for packet filtering (deciding whether to `ACCEPT`, `DROP`, or `REJECT` a packet). | `INPUT`, `OUTPUT`, `FORWARD` |
| **`nat`** | **(Network Address Translation)**. Used to modify the source or destination IP address of packets, enabling features like NAT and port forwarding. | `PREROUTING`, `POSTROUTING`, `OUTPUT` |
| **`mangle`** | Used for specialized packet alteration, such as modifying header fields like TTL or QoS bits. | `PREROUTING`, `INPUT`, `FORWARD`, `OUTPUT`, `POSTROUTING` |
| **`raw`** | Used to exempt certain packets from connection tracking. | `PREROUTING`, `OUTPUT` |

### 2. Chains
Chains are ordered lists of rules that are checked against packets as they pass through a specific Netfilter hook.

*   **Built-in Chains:** These are the default entry points for traffic.
    *   **`INPUT`:** For packets destined for the local machine itself.
    *   **`OUTPUT`:** For packets generated by the local machine.
    *   **`FORWARD`:** For packets that are being routed *through* the machine to another destination (i.e., the machine is acting as a router).
    *   **`PREROUTING`:** Processes packets as soon as they arrive on a network interface, *before* a routing decision is made.
    *   **`POSTROUTING`:** Processes packets just before they are about to leave a network interface, *after* a routing decision has been made.
*   **User-defined Chains:** Custom chains you can create to better organize your rules.

### 3. Rules and Targets
A **rule** is a specific condition that a packet is checked against. If a packet matches the rule, a specified **target** (action) is taken.

#### Common Targets (Actions)

| Target | Action |
| :--- | :--- |
| **`ACCEPT`**| **Allow** the packet to pass. |
| **`DROP`** | **Silently discard** the packet. The sender receives no notification. |
| **`REJECT`**| **Discard** the packet but send an error message (e.g., "port unreachable") back to the sender. |
| **`LOG`** | Log the packet's information to the system logs (`dmsg` or `/var/log/syslog`) and then pass it to the next rule in the chain. |
| **`SNAT`** | **Source NAT.** Modifies the source IP address of a packet. Used in the `POSTROUTING` chain. |
| **`DNAT`** | **Destination NAT.** Modifies the destination IP address of a packet. Used in the `PREROUTING` chain. |

---

## Crafting `iptables` Rules

### Basic Rule Syntax
```shell
sudo iptables -t <table> -A <chain>  <matches> -j <target>
```


*   `-t <table>`: Specifies the table (defaults to `filter` if omitted).
*   `-A <chain>`: **A**ppends the rule to the end of the specified chain.
*   `<matches>`: The criteria the packet must meet.
*   `-j <target>`: **J**umps to the specified target (action) if the packet matches.

### Common Matches (Criteria)

| Match | Option | Description |
| :--- | :--- | :--- |
| **Protocol** | `-p` or `--protocol`| Matches a specific protocol (e.g., `tcp`, `udp`, `icmp`). |
| **Source IP** | `-s` or `--source` | Matches the packet's source IP address or network range. |
| **Destination IP**| `-d` or `--destination`| Matches the packet's destination IP address. |
| **Destination Port**| `--dport` | Matches the destination port for TCP or UDP packets. |
| **Source Port** | `--sport` | Matches the source port for TCP or UDP packets. |
| **Input Interface**| `-i` | Matches the network interface a packet arrived on (e.g., `eth0`). |
| **Output Interface**| `-o` | Matches the network interface a packet will leave from. |
| **State** | `-m state --state`| A powerful match that uses connection tracking (e.g., `NEW`, `ESTABLISHED`, `RELATED`). |

### Practical Rule Examples

*   **Allow incoming SSH connections:**
    ```shell
    sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
    ```

*   **Allow established connections to continue:** (This is a crucial rule for any stateful firewall).
    ```shell
    sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
    ```

*   **Drop all other incoming traffic (default deny policy):**
    ```shell
    sudo iptables -P INPUT DROP
    ```
    *(Note: `-P` sets the default **P**olicy for a chain. This should be done only after you have set your `ACCEPT` rules, or you might lock yourself out!).*

*   **List all rules in the INPUT chain:**
    ```shell
    sudo iptables -L INPUT -n -v
    ```
    *   `-L`: List rules.
    *   `-n`: Numeric output (don't resolve IPs/ports to names).
    *   `-v`: Verbose output (show packet/byte counters).

